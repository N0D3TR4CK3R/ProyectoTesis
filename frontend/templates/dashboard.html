<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Activos Importantes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #181818;
            color: #f5f5f5;
        }
        .table-dark-custom {
            --bs-table-bg: #232323;
            --bs-table-striped-bg: #262626;
            --bs-table-hover-bg: #292929;
            --bs-table-color: #f5f5f5;
            --bs-table-border-color: #333;
            background-color: var(--bs-table-bg);
            color: var(--bs-table-color);
        }
        .table-dark-custom th {
            background: #1a1a1a;
            color: #ff9800;
            border-bottom: 2px solid #ff9800;
        }
        .table-dark-custom td {
            border-color: #333;
        }
        .badge.bg-secondary, .badge.bg-success, .badge.bg-danger {
            font-size: 1rem;
            padding: 0.6em 1.2em;
        }
        .table-dark-custom tr:hover {
            background: #333 !important;
        }
        .header-orange {
            color: #ff9800;
        }
        .card-dark {
            background: #232323;
            border: 1px solid #333;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 2rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0 header-orange">Dashboard de Activos Importantes</h1>
            <span id="backend-status" class="badge bg-secondary">Verificando backend...</span>
        </div>
        <div class="row">
            <!-- Columna izquierda: Activos -->
            <div class="col-lg-7 col-md-12 mb-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="filtro-tipo" class="form-label">Filtrar por tipo de activo:</label>
                        <select id="filtro-tipo" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filtro-ubicacion" class="form-label">Filtrar por ubicación:</label>
                        <select id="filtro-ubicacion" class="form-select">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div id="dashboard" class="card-dark mb-4">
                    <table class="table table-dark-custom table-striped table-hover rounded" id="tabla-activos">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Nombre</th>
                                <th>Ubicación</th>
                                <th>Código</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se llenarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Columna derecha: Predicciones -->
            <div class="col-lg-5 col-md-12">
                <div class="card-dark">
                    <h2 class="header-orange">Predicciones (Demostrativo)</h2>
                    <label for="select-activo" class="form-label">Selecciona un activo:</label>
                    <select id="select-activo" class="form-select mb-3">
                        <option value="">-- Selecciona --</option>
                    </select>
                    <div id="controles-prediccion" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">Controles disponibles:</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-warning" id="btn-riesgos">Riesgos</button>
                                <button type="button" class="btn btn-outline-warning" id="btn-vulnerabilidades">Vulnerabilidades</button>
                                <button type="button" class="btn btn-outline-warning" id="btn-amenazas">Amenazas</button>
                            </div>
                        </div>
                        <div id="resultado-prediccion" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let activosData = [];
        // Verificar estado del backend
        fetch('/api/health/')
            .then(response => response.ok ? response.json() : Promise.reject())
            .then(data => {
                const badge = document.getElementById('backend-status');
                badge.textContent = 'Backend online';
                badge.className = 'badge bg-success';
            })
            .catch(() => {
                const badge = document.getElementById('backend-status');
                badge.textContent = 'Backend offline';
                badge.className = 'badge bg-danger';
            });
        // Código JS para cargar los datos desde la API
        fetch('/api/activos-excel/')
            .then(response => response.json())
            .then(data => {
                activosData = data;
                poblarFiltros(data);
                renderTabla(data);
                poblarSelectActivos(data);
            });

        function poblarFiltros(data) {
            const tipos = [...new Set(data.map(a => a['type'] || a['tipo_activo'] || '').filter(Boolean))];
            const ubicaciones = [...new Set(data.map(a => a['ubication'] || a['ubicacion'] || '').filter(Boolean))];
            const filtroTipo = document.getElementById('filtro-tipo');
            const filtroUbicacion = document.getElementById('filtro-ubicacion');
            tipos.forEach(tipo => {
                const opt = document.createElement('option');
                opt.value = tipo;
                opt.textContent = tipo;
                filtroTipo.appendChild(opt);
            });
            ubicaciones.forEach(ubi => {
                const opt = document.createElement('option');
                opt.value = ubi;
                opt.textContent = ubi;
                filtroUbicacion.appendChild(opt);
            });
        }

        document.getElementById('filtro-tipo').addEventListener('change', filtrarTabla);
        document.getElementById('filtro-ubicacion').addEventListener('change', filtrarTabla);

        function filtrarTabla() {
            const tipo = document.getElementById('filtro-tipo').value;
            const ubicacion = document.getElementById('filtro-ubicacion').value;
            let filtrados = activosData;
            if (tipo) {
                filtrados = filtrados.filter(a => (a['type'] || a['tipo_activo'] || '') === tipo);
            }
            if (ubicacion) {
                filtrados = filtrados.filter(a => (a['ubication'] || a['ubicacion'] || '') === ubicacion);
            }
            renderTabla(filtrados);
        }

        function renderTabla(data) {
            const tbody = document.querySelector('#tabla-activos tbody');
            tbody.innerHTML = '';
            data.forEach(activo => {
                const row = `<tr>
                    <td>${activo['type'] || activo['tipo_activo'] || ''}</td>
                    <td>${activo['name'] || activo['nombre_activo'] || ''}</td>
                    <td>${activo['ubication'] || activo['ubicacion'] || ''}</td>
                    <td>${activo['code'] || activo['codigo'] || ''}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        function poblarSelectActivos(data) {
            const select = document.getElementById('select-activo');
            select.innerHTML = '<option value="">-- Selecciona --</option>';
            data.forEach((activo, idx) => {
                const nombre = activo['name'] || activo['nombre_activo'] || '';
                const tipo = activo['type'] || activo['tipo_activo'] || '';
                const ubicacion = activo['ubication'] || activo['ubicacion'] || '';
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = `${nombre} (${tipo} - ${ubicacion})`;
                select.appendChild(opt);
            });
        }

        document.getElementById('select-activo').addEventListener('change', function() {
            const idx = this.value;
            const controles = document.getElementById('controles-prediccion');
            const resultado = document.getElementById('resultado-prediccion');
            if (idx) {
                controles.style.display = '';
                resultado.innerHTML = '<em>Selecciona un control para ver detalles demostrativos.</em>';
            } else {
                controles.style.display = 'none';
                resultado.innerHTML = '';
            }
        });

        document.getElementById('btn-riesgos').addEventListener('click', function() {
            mostrarPrediccion('riesgos');
        });
        document.getElementById('btn-vulnerabilidades').addEventListener('click', function() {
            mostrarPrediccion('vulnerabilidades');
        });
        document.getElementById('btn-amenazas').addEventListener('click', function() {
            mostrarPrediccion('amenazas');
        });

        function mostrarPrediccion(tipo) {
            const idx = document.getElementById('select-activo').value;
            if (!idx) return;
            const activo = activosData[idx];
            let contenido = '';
            if (tipo === 'riesgos') {
                contenido = `<strong>Riesgos para:</strong> <span class='text-warning'>${activo['name'] || activo['nombre_activo']}</span><ul><li>Riesgo de pérdida o daño físico</li><li>Riesgo de acceso no autorizado</li><li>Riesgo de obsolescencia</li></ul>`;
            } else if (tipo === 'vulnerabilidades') {
                contenido = `<strong>Vulnerabilidades para:</strong> <span class='text-warning'>${activo['name'] || activo['nombre_activo']}</span><ul><li>Falta de mantenimiento</li><li>Configuración insegura</li><li>Dependencia de un solo proveedor</li></ul>`;
            } else if (tipo === 'amenazas') {
                contenido = `<strong>Amenazas para:</strong> <span class='text-warning'>${activo['name'] || activo['nombre_activo']}</span><ul><li>Robo o vandalismo</li><li>Desastres naturales</li><li>Ataques cibernéticos</li></ul>`;
            }
            document.getElementById('resultado-prediccion').innerHTML = contenido;
        }
    </script>
</body>
</html> 